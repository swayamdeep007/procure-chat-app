<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content" />
  <title>Western Railway Procurement Chat</title>
  <link rel="stylesheet" href="styles.css" />

  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>

  <input type="file" id="chat-file-input" hidden accept="image/*" onchange="handleChatImageSelect()">
  <input type="file" id="dp-file-input" hidden accept="image/*" onchange="handleDPSelect()">
  <input type="file" id="bulk-file-input" hidden accept="image/*" onchange="handleBulkImageSelect()">

  <div id="login-overlay">
    <div class="login-box">
      <h2>ğŸš‚ Western Railway Stores</h2>
      <p>Secure Login</p>
      <input type="email" id="login-email" placeholder="Email">
      <input type="password" id="login-password" placeholder="Password">
      <button onclick="loginUser()">Login</button>
      <p id="login-error" style="color:red; font-size:12px; margin-top:10px;"></p>
    </div>
  </div>

  <div id="app-container" style="display:none;">
    <div id="pl-sidebar">
      <div class="sidebar-header">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2 style="font-size:16px; margin:0; color:white;">ğŸš‚ WR Stores</h2>
            <div id="user-display" onclick="toggleUserMenu()">
                <span id="user-name-display">ğŸ‘¤ User</span>
                <span class="dropdown-arrow">â–¼</span>
                <div id="user-dropdown" class="dropdown-content">
                    <div class="dropdown-item" onclick="openDashboard()">ğŸ“ˆ Dashboard</div>
                    <div class="dropdown-item" onclick="openEditProfile()">âœï¸ Edit Profile</div>
                    <div class="dropdown-item" onclick="openReportsModal()">ğŸ“Š Reports</div>
                    <div id="menu-master-data" class="dropdown-item" onclick="openSettings()" style="display:none;">âš™ï¸ Master Data</div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item logout-item" onclick="logoutUser()">ğŸšª Logout</div>
                </div>
            </div>
        </div>

        <input id="pl-search" placeholder="ğŸ” Search PLs..." onkeyup="filterPLs()">
        
        <div class="filter-chips">
            <button id="btn-all" class="chip active" onclick="setFilter('All')">All</button>
            <button id="btn-urgent" class="chip chip-urgent" onclick="setFilter('Urgent')">Urg</button>
            <button id="btn-tpi" class="chip chip-tpi" onclick="setFilter('TPI')">TPI</button>
            <button id="btn-received" class="chip chip-received" onclick="setFilter('Received')">Rcvd</button>
            <button id="btn-multiselect" class="chip" style="border:1px solid #777;" onclick="toggleBulkMode()">â˜‘ï¸ Select</button>
        </div>
        
        <div id="bulk-action-bar" style="display:none; background:#292b2f; padding:5px; margin-top:5px; border-radius:4px;">
             <button onclick="openBulkChat()" style="width:100%; background:#5865f2; color:white; border:none; padding:8px; border-radius:4px; cursor:pointer; font-weight:bold;">ğŸ“¢ Broadcast (<span id="bulk-count">0</span>)</button>
        </div>
      </div>

      <div id="pl-list"></div>
      
      <div class="input-area">
        <input id="new-pl" placeholder="New PL Number">
        <input id="new-pl-desc" placeholder="Description">
        <button onclick="createPL()">+ Add PL Channel</button>
      </div>
    </div>

    <div id="chat-panel">
      <div id="standard-chat-header" class="chat-header" style="display:flex;">
        <div style="display:flex; align-items:center; width:100%;">
            <button id="back-btn" onclick="closeChat()">â†</button>
            <div class="header-img-container">
                <img id="header-pl-img" src="" class="header-pl-avatar" onclick="viewChannelDetails()" onerror="this.src='data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22100%22%20height%3D%22100%22%3E%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20fill%3D%22%23e0e0e0%22%2F%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20font-family%3D%22sans-serif%22%20font-size%3D%2235%22%20fill%3D%22%23888%22%20dy%3D%22.3em%22%20text-anchor%3D%22middle%22%3EPL%3C%2Ftext%3E%3C%2Fsvg%3E'">
                <button class="edit-dp-btn" onclick="triggerDPUpload()" title="Change Photo">ğŸ“·</button>
            </div>
            <div style="flex:1; overflow:hidden; margin-left:5px;">
                <h2 id="selected-pl-title" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Select a PL</h2>
                <div style="display:flex; align-items:center;">
                    <span id="selected-pl-desc" class="header-desc" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Western Railway Stores Dept.</span>
                    <span id="selected-pl-status" class="header-status"></span>
                </div>
            </div>
            <button id="export-chat-btn" onclick="exportChannelChat()" title="Download Chat" style="margin-left:10px; background:none; border:none; font-size:18px; cursor:pointer;">ğŸ“¥</button>
        </div>
      </div>

      <div id="bulk-chat-header" class="chat-header" style="display:none; background:#e3f2fd;">
          <h2>ğŸ“¢ Bulk Broadcast Mode</h2>
          <p style="font-size:12px; color:#555; margin-left:10px;">Sending to <b id="bulk-header-count">0</b> channels.</p>
          <button onclick="cancelBulkMode()" style="margin-left:auto; border:none; background:none; font-size:20px; cursor:pointer;">âœ–</button>
      </div>

      <div id="chat-box"></div>

      <div id="quick-tags" class="quick-tags" style="display:none;">
        <button class="msg-mode-btn" data-mode="Urgent" onclick="selectMessageMode('Urgent')" style="background:#ffebeb; color:#d32f2f; border: 2px solid #d32f2f;">ğŸš¨ Urgent</button>
        <button class="msg-mode-btn" data-mode="Delayed" onclick="selectMessageMode('Delayed')" style="background:#fff3e0; color:#f57c00; border: 2px solid #f57c00;">â±ï¸ Delayed</button>
        <button class="msg-mode-btn" data-mode="Escalated" onclick="selectMessageMode('Escalated')" style="background:#ffcdd2; color:#b71c1c; border: 2px solid #b71c1c;">ğŸ“ˆ Escalated</button>
        <button class="msg-mode-btn" data-mode="OnTime" onclick="selectMessageMode('OnTime')" style="background:#e8f5e9; color:#388e3c; border: 2px solid #388e3c;">âœ… OnTime</button>
        <button class="msg-mode-btn" data-mode="TPI" onclick="selectMessageMode('TPI')" style="background:#ede7f6; color:#673ab7; border: 2px solid #673ab7;">âš™ï¸ TPI</button>
        <button class="msg-mode-btn" data-mode="Received" onclick="selectMessageMode('Received')" style="background:#d9fdd3; color:#008069; border: 2px solid #008069;">ğŸ“¦ Received</button>
      </div>

      <div id="chat-controls" style="display:none;">
        <div class="message-row">
            <button id="btn-attach" onclick="triggerChatUpload()" title="Send Photo">ğŸ“</button>
            <input id="chat-input" placeholder="Type a message...">
            <button onclick="sendMessage()">â¤</button>
        </div>
        <div id="upload-progress-container" style="display:none; padding:0 5px 5px 5px;">
            <span style="font-size:10px; color:#008069;">Compressing & Sending image...</span>
        </div>
        <div class="meta-inputs">
            <input id="input-po" list="pos-list" placeholder="PO#" onchange="autoFillData()">
            <input id="input-sup" placeholder="Supplier"> 
            <input id="input-qty" placeholder="Qty">
            <input id="input-eta" type="date">
        </div>
      </div>

      <div id="bulk-controls" style="display:none; padding:15px; background:#f0f2f5; border-top:1px solid #ccc;">
          <div style="display:flex; gap:10px;">
              <button onclick="triggerBulkUpload()" style="background:#eee; color:#333; border:1px solid #ccc; width:40px; border-radius:4px;">ğŸ“</button>
              <input id="bulk-input" placeholder="Type message for all..." style="flex:1; padding:10px; border-radius:4px; border:1px solid #ccc;">
              <button onclick="sendBulkMessage()" style="background:#5865f2; color:white; border:none; padding:0 20px; border-radius:4px; font-weight:bold;">Send All</button>
          </div>
          <div id="bulk-progress" style="font-size:11px; color:#008069; margin-top:5px;"></div>
      </div>
    </div>
  </div>

  <datalist id="pos-list"></datalist>

  <div id="dashboard-modal" class="modal">
    <div class="modal-content" style="width: 95%; max-width: 1200px; height: 90vh; display: flex; flex-direction: column;">
        <div class="modal-header"><h3>ğŸ“ˆ Dashboard</h3><span class="close-btn" onclick="closeDashboard()">&times;</span></div>
        <div class="dashboard-body" style="flex:1; overflow-y:auto; padding:15px; background:#f4f6f8;">
            <div class="stats-grid">
                <div class="stat-card total"><div class="stat-val" id="dash-total">0</div><div class="stat-label">Total</div></div>
                <div class="stat-card urgent"><div class="stat-val" id="dash-urgent">0</div><div class="stat-label">Urgent</div></div>
                <div class="stat-card esc"><div class="stat-val" id="dash-esc">0</div><div class="stat-label">Escalated</div></div>
                <div class="stat-card tpi"><div class="stat-val" id="dash-tpi">0</div><div class="stat-label">TPI</div></div>
                <div class="stat-card received"><div class="stat-val" id="dash-received">0</div><div class="stat-label">Received</div></div>
            </div>
            <div style="margin-top:20px;">
                <h4 style="margin-bottom:10px; color:#333;">ğŸ“‹ Critical Items (Urgent / Escalated / Delayed)</h4>
                <div class="table-container">
                    <table id="dashboard-table">
                        <thead><tr><th>PL Number</th><th>Description</th><th>Status</th><th>Supplier</th><th>PO Qty</th><th>DPDT</th></tr></thead>
                        <tbody id="dashboard-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
  </div>

  <div id="reports-modal" class="modal">
      <div class="modal-content">
          <div class="modal-header"><h3>ğŸ“Š Reports</h3><span class="close-btn" onclick="closeReportsModal()">&times;</span></div>
          <div class="manage-section">
              <button onclick="downloadAllPLReport()" class="csv-btn" style="background:#008069;">ğŸ“¥ Download Global Report</button>
              <p id="report-status" style="font-size:11px; margin-top:5px;"></p>
          </div>
      </div>
  </div>

  <div id="settings-modal" class="modal">
      <div class="modal-content">
          <div class="modal-header"><h3>Master Data</h3><span class="close-btn" onclick="closeSettings()">&times;</span></div>
          <div class="manage-section">
              <input type="file" id="master-csv" accept=".csv" style="width:100%; margin-bottom:10px;">
              <button onclick="uploadMasterCSV()" class="csv-btn">ğŸš€ Upload</button>
              <p id="upload-status" style="font-size:11px; margin-top:5px;"></p>
          </div>
      </div>
  </div>

  <div id="profile-modal" class="modal">
      <div class="modal-content" style="width:300px;">
          <div class="modal-header"><h3>Edit Profile</h3><span class="close-btn" onclick="closeEditProfile()">&times;</span></div>
          <div class="manage-section">
              <input id="profile-name" placeholder="Name" style="width:100%; margin-bottom:10px;">
              <input id="profile-designation" placeholder="Designation" style="width:100%; margin-bottom:10px;">
              <button onclick="saveUserProfile()" class="csv-btn">Save</button>
          </div>
      </div>
  </div>

  <div id="channel-details-modal" class="modal">
      <div class="modal-content">
          <div class="modal-header"><h3>Details</h3><span class="close-btn" onclick="closeChannelDetails()">&times;</span></div>
          <div style="text-align:center; padding:10px;">
              <img id="detail-pl-img" src="" style="width:150px; height:150px; border-radius:50%; margin-bottom:10px;">
              <h2 id="detail-pl-title"></h2>
              <div id="detail-pl-desc"></div>
          </div>
      </div>
  </div>

  <script type="module" src="firebase-config.js"></script>
  <script type="module" src="utils.js"></script>
  <script type="module" src="app.js"></script>
</body>
</html>